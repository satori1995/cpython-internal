## æ¥”å­

åˆ†æäº†é‚£ä¹ˆä¹…çš„è™šæ‹Ÿæœºï¼Œå¤šå°‘ä¼šæœ‰ç‚¹æ— èŠï¼Œé‚£ä¹ˆæœ¬æ¬¡æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸ªå¥½ç©çš„ï¼Œçœ‹çœ‹å¦‚ä½•ä¿®æ”¹ Python çš„åº•å±‚æ•°æ®ç»“æ„å’Œè¿è¡Œæ—¶ã€‚äº†è§£è™šæ‹Ÿæœºé™¤äº†å¯ä»¥è®©æˆ‘ä»¬å†™å‡ºæ›´å¥½çš„ä»£ç ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å¯¹ Python è¿›è¡Œæ”¹é€ ã€‚ä¸¾ä¸ªæ —å­ï¼š

![](./images/393.png)

æ˜¯ä¸æ˜¯å¾ˆæœ‰è¶£å‘¢ï¼Ÿé€šè¿‡ Python å†…ç½®çš„ ctypes æ¨¡å—å³å¯åšåˆ°ï¼Œè€Œå…·ä½“çš„å®ç°æ–¹å¼ä¸€ä¼šå„¿è¯´ã€‚æ‰€ä»¥æœ¬æ¬¡çš„å·¥å…·å°±æ˜¯ ctypes æ¨¡å—ï¼Œéœ€è¦ä½ å¯¹å®ƒå·²ç»æˆ–å¤šæˆ–å°‘æœ‰ä¸€äº›äº†è§£ï¼Œå¦‚æœä¸äº†è§£çš„è¯ä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä»‹ç» ctypesã€‚

Python çš„å¯¹è±¡æœ¬è´¨ä¸Šå°±æ˜¯ C çš„ malloc å‡½æ•°ä¸ºç»“æ„ä½“å®ä¾‹åœ¨å †åŒºç”³è¯·çš„ä¸€å—å†…å­˜ï¼Œæ¯”å¦‚æ•´æ•°æ˜¯ PyLongObjectã€æµ®ç‚¹æ•°æ˜¯ PyFloatObjectã€åˆ—è¡¨æ˜¯ PyListObjectï¼Œä»¥åŠæ‰€æœ‰çš„ç±»å‹éƒ½æ˜¯ PyTypeObject ç­‰ç­‰ã€‚

ä¸‹é¢å°±æ¥æ„é€ è¿™äº›æ•°æ®ç»“æ„å¹¶è§‚å¯Ÿ Python å¯¹è±¡çš„è¿è¡Œæ—¶è¡¨ç°ã€‚

> **å…è´£å£°æ˜ï¼šæœ¬æ–‡ä»‹ç»çš„å†…å®¹ç»ä¸èƒ½ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œä»…ä»…åªæ˜¯ä¸ºäº†æ›´å¥½åœ°ç†è§£ Python è™šæ‹Ÿæœºã€æˆ–è€…åšæµ‹è¯•çš„æ—¶å€™ä½¿ç”¨ï¼Œç”¨äºç”Ÿäº§ç¯å¢ƒæ˜¯ç»å¯¹çš„å¤§å¿Œã€‚**

## æµ®ç‚¹æ•°

å…ˆæ¥çœ‹çœ‹æµ®ç‚¹æ•°ï¼Œå› ä¸ºæµ®ç‚¹æ•°æ¯”æ•´æ•°è¦ç®€å•ï¼Œçœ‹ä¸€ä¸‹åº•å±‚çš„å®šä¹‰ã€‚

```c
typedef struct {
    PyObject_HEAD
    double ob_fval;
} PyFloatObject;
```

é™¤äº† PyObject è¿™ä¸ªå…¬å…±çš„å¤´éƒ¨ä¿¡æ¯ä¹‹å¤–ï¼Œåªæœ‰ä¸€ä¸ªé¢å¤–çš„ ob_fvalï¼Œç”¨äºå­˜å‚¨å…·ä½“çš„å€¼ï¼Œè€Œç±»å‹ç›´æ¥ä½¿ç”¨ C çš„ doubleã€‚

```Python
from ctypes import *

class PyObject(Structure):
    # PyObjectï¼Œæ‰€æœ‰å¯¹è±¡åº•å±‚éƒ½ä¼šæœ‰è¿™ä¸ªç»“æ„ä½“
    _fields_ = [
        ("ob_refcnt", c_ssize_t),
        # ç±»å‹å¯¹è±¡ä¸€ä¼šå„¿è¯´ï¼Œè¿™é‡Œå°±å…ˆç”¨ void * æ¨¡æ‹Ÿ
        ("ob_type", c_void_p)  
    ]

class PyFloatObject(PyObject):
    # å®šä¹‰ PyFloatObjectï¼Œç»§æ‰¿ PyObject
    _fields_ = [
        ("ob_fval", c_double)
    ]

# åˆ›å»ºä¸€ä¸ªæµ®ç‚¹æ•°
f = 3.14
# æ„é€  PyFloatObjectï¼Œå°†å¯¹è±¡çš„åœ°å€ä¼ è¿›å»
# float_obj å°±æ˜¯ f åœ¨åº•å±‚çš„è¡¨ç°å½¢å¼
float_obj = PyFloatObject.from_address(id(f))
print(float_obj.ob_fval)  # 3.14

# ä¿®æ”¹ä¸€ä¸‹
print(
    f"f = {f}ï¼Œid(f) = {id(f)}"
)  # f = 3.14ï¼Œid(f) = 39868760276016
float_obj.ob_fval = 1.73
print(
    f"f = {f}ï¼Œid(f) = {id(f)}"
)  # f = 1.73ï¼Œid(f) = 39868760276016
```

æˆ‘ä»¬ä¿®æ”¹ float_obj.ob_fval ä¹Ÿä¼šå½±å“ fï¼Œå¹¶ä¸”ä¿®æ”¹å‰å f æŒ‡å‘çš„å¯¹è±¡çš„åœ°å€æ²¡æœ‰å‘ç”Ÿæ”¹å˜ã€‚åŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è§‚å¯Ÿä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œä¸¾ä¸ªæ —å­ï¼š

```Python
f = 3.14
float_obj = PyFloatObject.from_address(id(f))
# æ­¤æ—¶ 3.14 è¿™ä¸ªæµ®ç‚¹æ•°çš„å¼•ç”¨è®¡æ•°ä¸º 3
print(float_obj.ob_refcnt)  # 3
# å†æ¥ä¸€ä¸ª
f2 = f
print(float_obj.ob_refcnt)  # 4
f3 = f
print(float_obj.ob_refcnt)  # 5

# åˆ é™¤å˜é‡
del f2, f3
print(float_obj.ob_refcnt)  # 3
```

æ‰€ä»¥è¿™å°±æ˜¯å¼•ç”¨è®¡æ•°æœºåˆ¶ï¼Œå½“å¯¹è±¡è¢«å¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°åŠ  1ï¼›å½“å¼•ç”¨è¯¥å¯¹è±¡çš„å˜é‡è¢«åˆ é™¤ï¼Œå¼•ç”¨è®¡æ•°å‡ 1ï¼›å½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶ï¼Œå¯¹è±¡è¢«é”€æ¯ã€‚

## æ•´æ•°

å†æ¥çœ‹çœ‹æ•´æ•°ï¼Œæˆ‘ä»¬çŸ¥é“ Python æ•´æ•°æ˜¯ä¸ä¼šæº¢å‡ºçš„ï¼Œæ¢å¥è¯è¯´ï¼Œå®ƒå¯ä»¥è®¡ç®—æ— ç©·å¤§çš„æ•°ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå®ƒæ˜¯æ€ä¹ˆåŠåˆ°çš„å‘¢ï¼Ÿæƒ³è¦çŸ¥é“ç­”æ¡ˆï¼Œåªéœ€çœ‹åº•å±‚çš„ç»“æ„ä½“å®šä¹‰å³å¯ã€‚

```C
typedef struct {
    PyObject_VAR_HEAD
    // digit ç­‰ä»·äº unsigned int
    digit ob_digit[1];  
} PyLongObject;
```

æ˜ç™½äº†ï¼ŒåŸæ¥ Python çš„æ•´æ•°åœ¨åº•å±‚æ˜¯ç”¨æ•°ç»„å­˜å‚¨çš„ï¼Œé€šè¿‡ä¸²è”å¤šä¸ªæ— ç¬¦å· 32 ä½æ•´æ•°æ¥è¡¨ç¤ºæ›´å¤§çš„æ•°ã€‚

~~~Python
from ctypes import *

class PyVarObject(Structure):
    _fields_ = [
        ("ob_refcnt", c_ssize_t),
        ("ob_type", c_void_p),
        ("ob_size", c_ssize_t)
    ]

class PyLongObject(PyVarObject):
    _fields_ = [
        ("ob_digit", (c_uint32 * 1))
    ]

num = 1024
long_obj = PyLongObject.from_address(id(num))
print(long_obj.ob_digit[0])  # 1024
# PyLongObject çš„ ob_size è¡¨ç¤º ob_digit æ•°ç»„çš„é•¿åº¦
# æ­¤æ—¶æ˜¾ç„¶ä¸º 1
print(long_obj.ob_size)  # 1

# ä½†æ˜¯åœ¨ä»‹ç»æ•´æ•°çš„æ—¶å€™è¯´è¿‡ï¼Œob_size è¿˜å¯ä»¥è¡¨ç¤ºæ•´æ•°çš„ç¬¦å·
# æˆ‘ä»¬å°† ob_size æ”¹æˆ -1ï¼Œå†æ‰“å° num
long_obj.ob_size = -1
print(num)  # -1024
# æ­¤æ—¶å°±æ‚„æ‚„åœ°å°† num æ”¹æˆäº†è´Ÿæ•°
~~~

å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿®æ”¹å€¼ï¼š

```Python
num = 1024
long_obj = PyLongObject.from_address(id(num))
long_obj.ob_digit[0] = 4096
print(num)  # 4096
```

digit æ˜¯ 32 ä½æ— ç¬¦å·æ•´å‹ï¼Œä¸è¿‡è™½ç„¶å  32 ä¸ªä½ï¼Œä½†å®é™…åªç”¨ 30 ä¸ªä½ï¼Œè¿™ä¹Ÿæ„å‘³ç€ä¸€ä¸ª digit èƒ½å­˜å‚¨çš„æœ€å¤§æ•´æ•°å°±æ˜¯ 2 çš„ 30 æ¬¡æ–¹å‡ 1ã€‚å¦‚æœæ•°å€¼å†å¤§ä¸€äº›ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸¤ä¸ª digit æ¥å­˜å‚¨ï¼Œç¬¬äºŒä¸ª digit çš„æœ€ä½ä½ä» 31 å¼€å§‹ã€‚

```Python
# æ­¤æ—¶ä¸€ä¸ª digit èƒ½å¤Ÿå­˜å‚¨çš„ä¸‹ï¼Œæ‰€ä»¥ ob_size ä¸º 1
num1 = 2 ** 30 - 1
long_obj1 = PyLongObject.from_address(id(num1))
print(long_obj1.ob_size)  # 1

# æ­¤æ—¶ä¸€ä¸ª digit å­˜ä¸ä¸‹äº†ï¼Œæ‰€ä»¥éœ€è¦ä¸¤ä¸ª digitï¼Œå› æ­¤ ob_size ä¸º 2
num2 = 2 ** 30
long_obj2 = PyLongObject.from_address(id(num2))
print(long_obj2.ob_size)  # 2
```

å½“ç„¶äº†ï¼Œç”¨æ•°ç»„å®ç°å¤§æ•´æ•°çš„æ€è·¯å…¶å®æ²¡ä»€ä¹ˆæ–°é²œçš„ï¼Œéš¾ç‚¹åœ¨äºå¤§æ•´æ•°çš„æ•°å­¦è¿ç®—çš„å…·ä½“å®ç°ï¼Œå®ƒä»¬æ‰æ˜¯é‡ç‚¹ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒè€ƒéªŒç¼–ç¨‹åŠŸåº•çš„åœ°æ–¹ã€‚

## å­—èŠ‚åºåˆ—

å­—èŠ‚åºåˆ—å°±æ˜¯ Python çš„ bytes å¯¹è±¡ï¼Œåœ¨å­˜å‚¨æˆ–ç½‘ç»œé€šè®¯æ—¶ï¼Œä¼ è¾“çš„éƒ½æ˜¯å­—èŠ‚åºåˆ—ã€‚bytes å¯¹è±¡åœ¨åº•å±‚çš„ç»“æ„ä½“ä¸º PyBytesObjectï¼Œçœ‹ä¸€ä¸‹ç›¸å…³å®šä¹‰ã€‚

```C
typedef struct {
    PyObject_VAR_HEAD
    Py_hash_t ob_shash;
    char ob_sval[1];
} PyBytesObject;
```

è§£é‡Šä¸€ä¸‹é‡Œé¢æ¯ä¸ªå­—æ®µçš„å«ä¹‰ï¼š

+ PyObject_VAR_HEADï¼šå˜é•¿å¯¹è±¡çš„å…¬å…±å¤´éƒ¨ï¼›
+ ob_shashï¼šä¿å­˜è¯¥å­—èŠ‚åºåˆ—çš„å“ˆå¸Œå€¼ï¼Œä¹‹æ‰€ä»¥é€‰æ‹©ä¿å­˜æ˜¯å› ä¸ºåœ¨å¾ˆå¤šåœºæ™¯éƒ½éœ€è¦ bytes å¯¹è±¡çš„å“ˆå¸Œå€¼ã€‚è€Œ Python åœ¨è®¡ç®—å“ˆå¸Œå€¼çš„æ—¶å€™ï¼Œéœ€è¦éå†æ¯ä¸€ä¸ªå­—èŠ‚ï¼Œå› æ­¤å¼€é”€æ¯”è¾ƒå¤§ã€‚æ‰€ä»¥åœ¨è®¡ç®—ä¸€æ¬¡ä¹‹åä¼šä¿å­˜èµ·æ¥ï¼Œè¿™æ ·ä»¥åå°±ä¸éœ€è¦ç®—äº†ï¼Œå¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨ï¼Œå¹¶ä¸” bytes å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œæ‰€ä»¥å“ˆå¸Œå€¼æ˜¯ä¸å˜çš„ï¼›
+ ob_svalï¼šè¿™ä¸ªå’Œ PyLongObject ä¸­çš„ ob_digit çš„å£°æ˜æ–¹å¼æ˜¯ç±»ä¼¼çš„ï¼Œè™½ç„¶å£°æ˜çš„æ—¶å€™é•¿åº¦æ˜¯ 1ï¼Œä½†å…·ä½“æ˜¯å¤šå°‘åˆ™å–å†³äº bytes å¯¹è±¡çš„å­—èŠ‚æ•°é‡ã€‚è¿™æ˜¯ C è¯­è¨€ä¸­å®šä¹‰"å˜é•¿æ•°ç»„"çš„æŠ€å·§ï¼Œè™½ç„¶å†™çš„é•¿åº¦æ˜¯ 1ï¼Œä½†æ˜¯ä½ å¯ä»¥å½“æˆ n æ¥ç”¨ï¼Œn å¯å–ä»»æ„å€¼ã€‚æ˜¾ç„¶è¿™ä¸ª ob_sval å­˜å‚¨çš„æ˜¯æ‰€æœ‰çš„å­—èŠ‚ï¼Œå› æ­¤ Python ä¸­çš„ bytes å¯¹è±¡åœ¨åº•å±‚æ˜¯é€šè¿‡å­—ç¬¦æ•°ç»„å­˜å‚¨çš„ã€‚è€Œä¸”æ•°ç»„ä¼šå¤šç”³è¯·ä¸€ä¸ªç©ºé—´ï¼Œç”¨äºå­˜å‚¨ \\0ï¼Œå› ä¸º C æ˜¯é€šè¿‡ \\0 æ¥è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æ•°ç»„çš„ç»“æŸï¼Œä½†æ˜¯è®¡ç®— ob_size çš„æ—¶å€™ä¸åŒ…æ‹¬ \\0ï¼›

~~~python
from ctypes import *

class PyVarObject(Structure):
    _fields_ = [
        ("ob_refcnt", c_ssize_t),
        ("ob_type", c_void_p),
        ("ob_size", c_ssize_t)
    ]

class PyBytesObject(PyVarObject):
    _fields_ = [
        ("ob_shash", c_ssize_t),
        # è¿™é‡Œæˆ‘ä»¬å°±å°†é•¿åº¦å£°æ˜ä¸º 100
        ("ob_sval", (c_char * 100))
    ]

b = b"hello"
bytes_obj = PyBytesObject.from_address(id(b))
# é•¿åº¦
print(bytes_obj.ob_size, len(b))  # 5 5
# å“ˆå¸Œå€¼
print(bytes_obj.ob_shash)  # 967846336661272849
print(hash(b))  # 967846336661272849

# ä¿®æ”¹å“ˆå¸Œå€¼ï¼Œå†è°ƒç”¨ hash å‡½æ•°ä¼šå‘ç°ç»“æœå˜äº†
# è¯´æ˜ hash(b) ä¼šç›´æ¥è·å–åº•å±‚å·²ç»è®¡ç®—å¥½çš„ ob_shash å­—æ®µçš„å€¼
bytes_obj.ob_shash = 666
print(hash(b))  # 666

# ä¿®æ”¹ ob_sval
bytes_obj.ob_sval = b"hello world"
print(b)  # b'hello'
# æˆ‘ä»¬çœ‹åˆ°æ‰“å°çš„ä¾æ—§æ˜¯ "hello"
# åŸå› æ˜¯ ob_size ä¸º 5ï¼Œåªä¼šé€‰æ‹©å‰ 5 ä¸ªå­—èŠ‚
# ä¿®æ”¹ä¹‹åå†æ¬¡æ‰“å°
bytes_obj.ob_size = 11
print(b)  # b'hello world'
bytes_obj.ob_size = 15
# ç”¨ \0 å¡«å……
print(b)  # b'hello world\x00\x00\x00\x00'
~~~

é™¤äº† bytes å¯¹è±¡ä¹‹å¤–ï¼ŒPython è¿˜æœ‰ä¸€ä¸ª bytearray å¯¹è±¡ï¼Œå®ƒå’Œ bytes å¯¹è±¡ç±»ä¼¼ï¼Œåªä¸è¿‡ bytes å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œè€Œ bytearray å¯¹è±¡æ˜¯å¯å˜çš„ã€‚

## åˆ—è¡¨

åˆ—è¡¨å¯ä»¥è¯´ä½¿ç”¨çš„éå¸¸å¹¿æ³›äº†ï¼Œåœ¨åˆå­¦åˆ—è¡¨çš„æ—¶å€™ï¼Œæœ‰äººä¼šå‘Šè¯‰ä½ åˆ—è¡¨å°±æ˜¯ä¸€ä¸ªå¤§ä»“åº“ï¼Œä»€ä¹ˆéƒ½å¯ä»¥å­˜æ”¾ã€‚ä½†æˆ‘ä»¬çŸ¥é“ï¼Œåˆ—è¡¨ä¸­å­˜æ”¾çš„å…ƒç´ å…¶å®éƒ½æ˜¯æ³›å‹æŒ‡é’ˆ PyObject *ã€‚

çœ‹çœ‹åˆ—è¡¨çš„åº•å±‚ç»“æ„ï¼š

```c
typedef struct {
    PyObject_VAR_HEAD
    PyObject **ob_item;
    Py_ssize_t allocated;
} PyListObject;
```

é‡Œé¢æœ‰å¦‚ä¸‹å­—æ®µï¼š

- PyObject_VAR_HEADï¼šå˜é•¿å¯¹è±¡çš„å…¬å…±å¤´éƒ¨ä¿¡æ¯ï¼›
- ob_itemï¼šä¸€ä¸ªäºŒçº§æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª PyObject * ç±»å‹çš„æŒ‡é’ˆæ•°ç»„ï¼Œè¿™ä¸ªæŒ‡é’ˆæ•°ç»„ä¿å­˜çš„ä¾¿æ˜¯å¯¹è±¡çš„æŒ‡é’ˆï¼Œè€Œæ“ä½œåº•å±‚æ•°ç»„éƒ½æ˜¯é€šè¿‡ ob_item æ¥è¿›è¡Œæ“ä½œçš„ï¼›
- allocatedï¼šå®¹é‡ï¼Œæˆ‘ä»¬çŸ¥é“åˆ—è¡¨åº•å±‚æ˜¯ä½¿ç”¨äº† C çš„æ•°ç»„ï¼Œè€Œåº•å±‚æ•°ç»„çš„é•¿åº¦å°±æ˜¯åˆ—è¡¨çš„å®¹é‡ï¼›

```Python
from ctypes import *

class PyVarObject(Structure):
    _fields_ = [
        ("ob_refcnt", c_ssize_t),
        ("ob_type", c_void_p),
        ("ob_size", c_ssize_t)
    ]

class PyListObject(PyVarObject):
    _fields_ = [
        # ctypes ä¸‹é¢æœ‰ä¸€ä¸ª py_object ç±»ï¼Œå®ƒç­‰ä»·äºåº•å±‚çš„ PyObject *
        # ä½† ob_item ç±»å‹ä¸º PyObject **ï¼Œæ‰€ä»¥è¿™é‡Œçš„ç±»å‹å£°æ˜ä¸º POINTER(py_object)
        ("ob_item", POINTER(py_object)),
        ("allocated", c_ssize_t)
    ]

lst = [1, 2, 3, 4, 5]
list_obj = PyListObject.from_address(id(lst))
# åˆ—è¡¨åœ¨è®¡ç®—é•¿åº¦çš„æ—¶å€™ï¼Œä¼šç›´æ¥è·å– ob_size å­—æ®µçš„å€¼
# å¯¹å…ƒç´ è¿›è¡Œæ·»åŠ ã€åˆ é™¤ï¼Œob_size ä¹Ÿä¼šåŠ¨æ€å˜åŒ–ï¼Œå› ä¸ºè¯¥å­—æ®µè´Ÿè´£ç»´æŠ¤åˆ—è¡¨çš„é•¿åº¦
print(list_obj.ob_size)  # 5
print(len(lst))  # 5

# ä¿®æ”¹ ob_size ä¸º 2ï¼Œæ‰“å°åˆ—è¡¨åªä¼šæ˜¾ç¤ºä¸¤ä¸ªå…ƒç´ 
list_obj.ob_size = 2
print(lst)  # [1, 2]
try:
    lst[2]  # è®¿é—®ç´¢å¼•ä¸º 2 çš„å…ƒç´ ä¼šè¶Šç•Œ
except IndexError as e:
    print(e)  # list index out of range

# ä¿®æ”¹å…ƒç´ ï¼Œç”±äº ob_item é‡Œé¢çš„å…ƒç´ æ˜¯ PyObject *
# æ‰€ä»¥è¿™é‡Œéœ€è¦è°ƒç”¨ py_object æ˜¾å¼è½¬ä¸€ä¸‹
list_obj.ob_item[0] = py_object("ğŸ˜‚")
print(lst)  # ['ğŸ˜‚', 2]
```

æ˜¯ä¸æ˜¯å¾ˆæœ‰è¶£å‘¢ï¼Ÿ

## å…ƒç»„

ä¸‹é¢æ¥çœ‹çœ‹å…ƒç»„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå…ƒç»„çœ‹æˆæ˜¯ä¸æ”¯æŒå…ƒç´ æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤ç­‰æ“ä½œçš„åˆ—è¡¨ã€‚å…ƒç»„çš„å®ç°æœºåˆ¶éå¸¸ç®€å•ï¼Œå¯ä»¥çœ‹ä½œæ˜¯åœ¨åˆ—è¡¨çš„åŸºç¡€ä¸Šä¸¢å¼ƒäº†å¢åˆ æ”¹ç­‰æ“ä½œã€‚

```C
typedef struct {
    PyObject_VAR_HEAD
    PyObject *ob_item[1];
} PyTupleObject;
```

å…ƒç»„çš„åº•å±‚ç»“æ„ä½“å®šä¹‰ä¹Ÿéå¸¸ç®€å•ï¼Œä¸€ä¸ªå¼•ç”¨è®¡æ•°ã€ä¸€ä¸ªç±»å‹ã€ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„é‡Œé¢çš„ 1 å¯ä»¥æƒ³è±¡æˆ nã€‚å’Œåˆ—è¡¨ä¸åŒï¼Œå…ƒç»„æ²¡æœ‰ allocatedï¼Œå› ä¸ºå®ƒæ˜¯ä¸å¯å˜çš„ï¼Œä¸æ”¯æŒæ‰©å®¹æ“ä½œã€‚

```python
from ctypes import *

class PyVarObject(Structure):
    _fields_ = [
        ("ob_refcnt", c_ssize_t),
        ("ob_type", c_void_p),
        ("ob_size", c_ssize_t)
    ]

class PyTupleObject(PyVarObject):
    _fields_ = [
        # è¿™é‡Œæˆ‘ä»¬å‡è®¾é‡Œé¢å¯ä»¥å­˜ 10 ä¸ªå…ƒç´ 
        ("ob_item", (py_object * 10)),
    ]

tpl = (11, 22, 33)
tuple_obj = PyTupleObject.from_address(id(tpl))
print(tuple_obj.ob_size)  # 3
print(len(tpl))  # 3

# ä¿®æ”¹å…ƒç»„å†…çš„å…ƒç´ 
print(f"ä¿®æ”¹å‰ï¼šid(tpl) = {id(tpl)}ï¼Œtpl = {tpl}")
tuple_obj.ob_item[0] = py_object("ğŸ‘")
print(f"ä¿®æ”¹åï¼šid(tpl) = {id(tpl)}ï¼Œtpl = {tpl}")
"""
ä¿®æ”¹å‰ï¼šid(tpl) = 140570376749888ï¼Œtpl = (11, 22, 33)
ä¿®æ”¹åï¼šid(tpl) = 140570376749888ï¼Œtpl = ('ğŸ‘', 22, 33)
"""
```

æ­¤æ—¶æˆ‘ä»¬å°±æˆåŠŸä¿®æ”¹äº†å…ƒç»„é‡Œé¢çš„å…ƒç´ ï¼Œå¹¶ä¸”ä¿®æ”¹å‰åå…ƒç»„çš„åœ°å€æ²¡æœ‰æ”¹å˜ã€‚

æ‰€è°“çš„å¯¹è±¡æ˜¯å¦å¯å˜ï¼Œå–å†³äºè§£é‡Šå™¨æœ‰æ²¡æœ‰å°†ä¿®æ”¹å¯¹è±¡çš„æ¥å£æš´éœ²ç»™æˆ‘ä»¬ï¼Œä½†ç«™åœ¨è§£é‡Šå™¨çš„è§’åº¦ä¸Šï¼Œæ²¡æœ‰ä»€ä¹ˆå¯å˜ä¸å¯å˜ï¼Œéƒ½æ˜¯å¯å˜çš„ã€‚

## ç»™ç±»å¯¹è±¡å¢åŠ å±æ€§

æˆ‘ä»¬çŸ¥é“ç±»å¯¹è±¡æ˜¯æœ‰è‡ªå·±çš„å±æ€§å­—å…¸çš„ï¼Œä½†è¿™ä¸ªå­—å…¸ä¸å…è®¸ä¿®æ”¹ï¼Œå› ä¸ºå‡†ç¡®æ¥è¯´å®ƒä¸æ˜¯å­—å…¸ï¼Œè€Œæ˜¯ä¸€ä¸ª mappingproxy å¯¹è±¡ã€‚

```Python
print(str.__dict__.__class__)  # <class 'mappingproxy'>

try:
    str.__dict__["å˜¿"] = "è›¤"
except Exception as e: 
    print(e)  # 'mappingproxy' object does not support item assignment
```

æˆ‘ä»¬æ— æ³•é€šè¿‡ä¿®æ”¹ mappingproxy å¯¹è±¡æ¥ç»™ç±»å¢åŠ å±æ€§ï¼Œå› ä¸ºå®ƒä¸æ”¯æŒå¢åŠ ã€ä¿®æ”¹ä»¥åŠåˆ é™¤æ“ä½œã€‚å½“ç„¶è‡ªå®šä¹‰çš„ç±»å¯ä»¥é€šè¿‡ setattr æ–¹æ³•å®ç°ï¼Œä½†å†…ç½®çš„ç±»æ˜¯è¡Œä¸é€šçš„ï¼Œå†…ç½®çš„ç±»æ— æ³•é€šè¿‡ setattr è¿›è¡Œå±æ€§æ·»åŠ ã€‚

å› æ­¤å¦‚æœæƒ³ç»™å†…ç½®çš„ç±»å¢åŠ å±æ€§ï¼Œåªèƒ½é€šè¿‡ mappingproxy å…¥æ‰‹ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„åº•å±‚ç»“æ„ã€‚

![](./images/394.png)

æ‰€è°“çš„ mappingproxy å°±æ˜¯å¯¹å­—å…¸åŒ…äº†ä¸€å±‚ï¼Œå¹¶åªæä¾›äº†æŸ¥è¯¢åŠŸèƒ½ã€‚è€Œä¸”ä»å‡½æ•° mappingproxy_len å’Œ mappingproxy_getitem å¯ä»¥çœ‹å‡ºï¼Œmappingproxy å¯¹è±¡çš„é•¿åº¦å°±æ˜¯å†…éƒ¨å­—å…¸çš„é•¿åº¦ï¼Œè·å– mappingproxy å¯¹è±¡çš„å…ƒç´ å®é™…ä¸Šå°±æ˜¯è·å–å†…éƒ¨å­—å…¸çš„å…ƒç´ ï¼Œå› æ­¤æ“ä½œ mappingproxy å¯¹è±¡å°±ç­‰ä»·äºæ“ä½œå…¶å†…éƒ¨çš„å­—å…¸ã€‚

æ‰€ä»¥æˆ‘ä»¬åªè¦èƒ½æ‹¿åˆ° mappingproxy å¯¹è±¡å†…éƒ¨çš„å­—å…¸ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥æ“ä½œå­—å…¸æ¥ä¿®æ”¹ç±»å±æ€§ã€‚è€Œ Python æœ‰ä¸€ä¸ªæ¨¡å—å« gcï¼Œå®ƒå¯ä»¥å¸®æˆ‘ä»¬å®ç°è¿™ä¸€ç‚¹ï¼Œä¸¾ä¸ªæ —å­ï¼š

~~~python
import gc

tpl = ("hello", 123, "ğŸ˜’")
# gc.get_referents(obj) è¿”å›æ‰€æœ‰è¢« obj å¼•ç”¨çš„å¯¹è±¡
# ä»¥åˆ—è¡¨çš„å½¢å¼è¿”å›
print(gc.get_referents(tpl))  # ['ğŸ˜’', 123, 'hello']
# æ˜¾ç„¶ tpl å¼•ç”¨çš„å°±æ˜¯å†…éƒ¨çš„ä¸‰ä¸ªå…ƒç´ 

# æ­¤å¤–è¿˜æœ‰ gc.get_referrers(obj)ï¼Œå®ƒä¼šè¿”å›æ‰€æœ‰å¼•ç”¨äº† obj çš„å¯¹è±¡
~~~

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä½ è§‰å¾— mappingproxy å¯¹è±¡å¼•ç”¨äº†è°å‘¢ï¼Ÿæ˜¾ç„¶å°±æ˜¯å†…éƒ¨çš„å­—å…¸ã€‚

```python
import gc

# str.__dict__ æ˜¯ä¸€ä¸ª mappingproxy å¯¹è±¡
# è¿™é‡Œæ‹¿åˆ°å…¶å†…éƒ¨çš„å­—å…¸
d = gc.get_referents(str.__dict__)[0]
# éšä¾¿å¢åŠ ä¸€ä¸ªå±æ€§
d["å˜¿"] = "è›¤"
print(str.å˜¿)  # è›¤
print("å˜¿".å˜¿)  # è›¤

# å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å¢åŠ ä¸€ä¸ªå‡½æ•°ï¼Œè®°å¾—è¦æœ‰ä¸€ä¸ª self å‚æ•°
d["smile"] = lambda self: self + "ğŸ˜Š"
print("å¾®ç¬‘".smile())  # å¾®ç¬‘ğŸ˜Š
print(str.smile("å¾®ç¬‘"))  # å¾®ç¬‘ğŸ˜Š
```

ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸Šé¢æ·»åŠ çš„æ˜¯ä¸å­˜åœ¨çš„æ–°å±æ€§ï¼Œå¦‚æœæ˜¯è¦†ç›–ä¸€ä¸ªå·²ç»å­˜åœ¨çš„å±æ€§æˆ–è€…å‡½æ•°ï¼Œé‚£ä¹ˆè¿˜ç¼ºä¸€æ­¥ã€‚

~~~python
from ctypes import *
import gc

s = "hello world"
print(s.split())  # ['hello', 'world']

d = gc.get_referents(str.__dict__)[0]
# è¦†ç›– split å‡½æ•°
d["split"] = lambda self, *args: "æˆ‘è¢« split äº†"
# è¿™é‡Œéœ€è¦è°ƒç”¨ pythonapi.PyType_Modified æ¥æ›´æ–°ä¸Šé¢æ‰€åšçš„ä¿®æ”¹
# å¦‚æœæ²¡æœ‰è¿™ä¸€æ­¥ï¼Œé‚£ä¹ˆæ˜¯æ²¡æœ‰æ•ˆæœçš„ï¼Œç”šè‡³è¿˜ä¼šå‡ºç°ä¸‘é™‹çš„æ®µé”™è¯¯ï¼Œä½¿å¾—è§£é‡Šå™¨å¼‚å¸¸é€€å‡º
pythonapi.PyType_Modified(py_object(str))
print(s.split())  # æˆ‘è¢« split äº†
~~~

ä½†æ˜¯è¿˜ä¸å¤Ÿå®Œå–„ï¼Œå› ä¸ºå‡½æ•°çš„åå­—æ²¡æœ‰ä¿®æ”¹ï¼Œè€Œä¸”è¦†ç›–ä¹‹ååŸæ¥çš„åå­—ä¹Ÿæ‰¾ä¸åˆ°äº†ã€‚

```Python
print(s.split.__name__)  # <lambda>
```

å‡½æ•°åœ¨ä¿®æ”¹ä¹‹ååå­—å°±å˜äº†ï¼ŒåŒ¿åå‡½æ•°çš„åå­—å°±å« \<lambda\>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å†å®Œå–„ä¸€ä¸‹ã€‚

~~~Python
from ctypes import *
import gc

def patch_builtin_class(cls, name, value):
    """
    :param cls: è¦ä¿®æ”¹çš„ç±»
    :param name: å±æ€§åæˆ–è€…å‡½æ•°å
    :param value: å€¼
    :return:
    """
    if type(cls) is not type:
        raise ValueError("cls å¿…é¡»æ˜¯ä¸€ä¸ªç±»å¯¹è±¡")
    # è·å– cls.__dict__ å†…éƒ¨çš„å­—å…¸
    cls_attrs = gc.get_referents(cls.__dict__)[0]
    # å¦‚æœè¯¥å±æ€§æˆ–å‡½æ•°ä¸å­˜åœ¨ï¼Œç»“æœä¸º None
    # å¦åˆ™å°†å€¼å–å‡ºæ¥ï¼Œèµ‹å€¼ç»™ old_value
    old_value = cls_attrs.get(name, None)
    # å°† nameã€value ç»„åˆèµ·æ¥æ”¾åˆ° cls_attrs ä¸­ï¼Œä¸º cls è¿™ä¸ªç±»æ·»ç –åŠ ç“¦
    cls_attrs[name] = value

    # å¦‚æœ old_value ä¸º Noneï¼Œè¯´æ˜æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªæ–°çš„å±æ€§æˆ–å‡½æ•°
    # å¦‚æœ old_value ä¸ä¸º Noneï¼Œè¯´æ˜æˆ‘ä»¬è¦†ç›–äº†ä¸€ä¸ªå·²å­˜åœ¨çš„å±æ€§æˆ–å‡½æ•°
    if old_value is not None:
        try:
            # å°†åŸæ¥å‡½æ•°çš„ __name__ã€__qualname__ èµ‹å€¼ç»™æ–°çš„å‡½æ•°
            # å¦‚æœä¸æ˜¯å‡½æ•°ï¼Œè€Œæ˜¯æ™®é€šå±æ€§ï¼Œé‚£ä¹ˆä¼šå› ä¸ºæ²¡æœ‰ __name__ è€ŒæŠ›å‡º AttributeError
            # è¿™é‡Œæˆ‘ä»¬ç›´æ¥ pass æ‰å³å¯ï¼Œæ— éœ€å…³å¿ƒ
            value.__name__ = old_value.__name__
            value.__qualname__ = old_value.__qualname__
        except AttributeError:
            pass
        # ä½†æ˜¯åŸæ¥çš„å±æ€§æˆ–å‡½æ•°æœ€å¥½ä¹Ÿä¸è¦ä¸¢å¼ƒï¼Œæˆ‘ä»¬å¯ä»¥æ”¹ä¸€ä¸ªåå­—
        # å‡è®¾æˆ‘ä»¬ä¿®æ”¹ split å‡½æ•°ï¼Œé‚£ä¹ˆä¿®æ”¹ä¹‹å
        # åŸæ¥çš„ split å°±éœ€è¦é€šè¿‡ _str_split è¿›è¡Œè°ƒç”¨
        cls_attrs[f"_{cls.__name__}_{name}"] = old_value

    # ä¸è¦å¿˜äº†æœ€å…³é”®çš„ä¸€æ­¥
    pythonapi.PyType_Modified(py_object(cls))


s = "hello world"
print(s.title())  # Hello World
# ä¿®æ”¹å†…ç½®å±æ€§
patch_builtin_class(str, "title", lambda self: "æˆ‘å•è¯é¦–å­—æ¯å¤§å†™äº†")
print(s.title())  # æˆ‘å•è¯é¦–å­—æ¯å¤§å†™äº†
print(s.title.__name__)  # title
# è€ŒåŸæ¥çš„ title åˆ™éœ€è¦é€šè¿‡ _str_title è¿›è¡Œè°ƒç”¨
print(s._str_title())  # Hello World
~~~

æ˜¯ä¸æ˜¯å¾ˆå¥½ç©å‘¢ï¼Ÿå¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥ä¿®æ”¹ strï¼Œä»»æ„çš„å†…ç½®çš„ç±»éƒ½æ˜¯å¯ä»¥ä¿®æ”¹çš„ã€‚

```Python
lst = [1, 2, 3]
# å°† append å‡½æ•°æ¢æˆ pop å‡½æ•°
patch_builtin_class(list, "append", lambda self: list.pop(self))
# æˆ‘ä»¬çŸ¥é“ append éœ€è¦æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œä½†è¿™é‡Œä¸éœ€è¦ä¼ ï¼Œå› ä¸ºå‡½æ•°å·²ç»è¢«æ¢æ‰äº†
lst.append()
print(lst)  # [1, 2]
# è€ŒåŸæ¥çš„ append å‡½æ•°ï¼Œåˆ™éœ€è¦é€šè¿‡ _list_append è¿›è¡Œè°ƒç”¨
lst._list_append(666)
print(lst)  # [1, 2, 666]
```

æˆ‘ä»¬è¿˜å¯ä»¥æ·»åŠ ä¸€ä¸ªç±»æ–¹æ³•æˆ–é™æ€æ–¹æ³•ï¼š

~~~Python
patch_builtin_class(
    list,
    "new",
    classmethod(lambda cls, n: list(range(n)))
)
print(list.new(5))  # [0, 1, 2, 3, 4]
~~~

è¿˜æ˜¯å¾ˆæœ‰è¶£çš„ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç›®å‰çš„ patch_builtin_class åªèƒ½ä¸ºç±»æ·»åŠ å±æ€§æˆ–å‡½æ•°ï¼Œä½†å…¶ "å®ä¾‹å¯¹è±¡" ä½¿ç”¨æ“ä½œç¬¦æ—¶çš„è¡¨ç°æ˜¯æ— æ³•æ“æ§çš„ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæˆ‘ä»¬ä¸¾ä¸ªæ —å­ï¼š

~~~Python
a, b = 3, 4
# æ¯ä¸€ä¸ªæ“ä½œèƒŒåéƒ½è¢«æŠ½è±¡æˆäº†ä¸€ä¸ªé­”æ³•æ–¹æ³•
print(int.__add__(a, b))  # 7
print(a.__add__(b))  # 7
print(a + b)  # 7

# é‡å†™ __add__
patch_builtin_class(int, "__add__", lambda self, other: self * other)
print(int.__add__(a, b))  # 12
print(a.__add__(b))  # 12
print(a + b)  # 7
~~~

æˆ‘ä»¬çœ‹åˆ°é‡å†™äº† \_\_add\_\_ ä¹‹åï¼Œç›´æ¥è°ƒç”¨é­”æ³•æ–¹æ³•çš„è¯æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œæ‰“å°çš„æ˜¯é‡å†™ä¹‹åçš„ç»“æœã€‚è€Œä½¿ç”¨æ“ä½œç¬¦ + æ—¶ï¼Œå´æ²¡æœ‰èµ°æˆ‘ä»¬é‡å†™ä¹‹åçš„ \_\_add\_\_ï¼Œæ‰€ä»¥ a + b çš„ç»“æœè¿˜æ˜¯ 7ã€‚

~~~python
s1, s2 = "hello", "world"
patch_builtin_class(str, 
                    "__sub__", 
                    lambda self, other: (self, other))
print(s1.__sub__(s2))  
# ('hello', 'world')

try:
    s1 - s2
except TypeError as e:
    print(e) 
# unsupported operand type(s) for -: 'str' and 'str'
~~~

é‡å†™äº† \_\_sub\_\_ ä¹‹åï¼Œç›´æ¥è°ƒç”¨é­”æ³•æ–¹æ³•çš„è¯ä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯ç”¨æ“ä½œç¬¦çš„æ–¹å¼å°±ä¼šæŠ¥é”™ï¼Œå‘Šè¯‰æˆ‘ä»¬å­—ç¬¦ä¸²ä¸æ”¯æŒå‡æ³•æ“ä½œï¼Œä½†æ˜æ˜å®ç°äº† \_\_sub\_\_ æ–¹æ³•å•Šã€‚

ä»‹ç»ç±»å‹å¯¹è±¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°é‡Œé¢æœ‰ä¸‰ä¸ªæ“ä½œç°‡ï¼š

- tp_as_numberï¼šå®ä¾‹å¯¹è±¡ä¸ºæ•°å€¼æ—¶ï¼Œæ‰€æ”¯æŒçš„æ“ä½œï¼›
- tp_as_sequenceï¼šå®ä¾‹å¯¹è±¡ä¸ºåºåˆ—æ—¶ï¼Œæ‰€æ”¯æŒçš„æ“ä½œï¼›
- tp_as_mappingï¼šå®ä¾‹å¯¹è±¡ä¸ºæ˜ å°„æ—¶ï¼Œæ‰€æ”¯æŒçš„æ“ä½œï¼›

å®ƒä»¬éƒ½æ˜¯ç»“æ„ä½“æŒ‡é’ˆï¼ŒæŒ‡å‘çš„ç»“æ„ä½“ä¸­çš„æ¯ä¸€ä¸ªå­—æ®µéƒ½æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘çš„å‡½æ•°ä¾¿æ˜¯å®ä¾‹å¯¹è±¡å¯æ‰§è¡Œçš„æ“ä½œã€‚ä»¥ int ç±»å‹ä¸ºä¾‹ï¼Œint åœ¨åº•å±‚å¯¹åº” PyLong_Typeï¼Œå®ƒçš„ tp_as_number å­—æ®µè¢«åˆå§‹åŒ–ä¸º &long_as_numberï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ã€‚

![](./images/395.png)

å› æ­¤ PyNumberMethods çš„å­—æ®µå°±æ˜¯æ•´æ•°æ‰€æ‹¥æœ‰çš„é­”æ³•æ–¹æ³•ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬æµ®ç‚¹æ•°ã€‚

è€Œæˆ‘ä»¬è‹¥æƒ³æ”¹å˜æ“ä½œç¬¦çš„è¡¨ç°è¡Œä¸ºï¼Œéœ€è¦ä¿®æ”¹çš„æ˜¯ tp_as_\* é‡Œé¢çš„å­—æ®µï¼Œè€Œä¸æ˜¯ç®€å•åœ°ä¿®æ”¹å±æ€§å­—å…¸ã€‚æ¯”å¦‚æˆ‘ä»¬æƒ³ä¿®æ”¹ a + b çš„è¡¨ç°è¡Œä¸ºï¼Œé‚£ä¹ˆå°±å°†ç±»å¯¹è±¡çš„ tp_as_number é‡Œé¢çš„ nb_add ç»™æ”¹æ‰ã€‚

ä¿®æ”¹æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œå¦‚æœæ˜¯æ•´å½¢ï¼Œé‚£ä¹ˆå°±è¦†ç›–æ‰ long_addï¼Œä¹Ÿå°±æ˜¯ `(&PyLong_Type)->long_as_number->nb_add`ï¼›åŒç†ï¼Œå¦‚æœæ˜¯æµ®ç‚¹å‹ï¼Œé‚£ä¹ˆå°±è¦†ç›–æ‰ float_addï¼Œä¹Ÿå°±æ˜¯ `(&PyFloat_Type)->float_as_number->nb_add`ã€‚

## é‡è½½æ“ä½œç¬¦

å…ˆè¯´æ˜ä¸€ä¸‹ï¼Œæˆ‘ä»¬è¿™é‡Œé’ˆå¯¹çš„éƒ½æ˜¯å†…ç½®çš„ç±»ã€‚å¦‚æœæ˜¯è‡ªå®šä¹‰çš„ç±»ï¼Œé‚£ä¹ˆåˆ©ç”¨ Python çš„åŠ¨æ€ç‰¹æ€§å°±è¶³å¤Ÿäº†ã€‚

ç±»å¯¹è±¡æœ‰ 4 ä¸ªæ–¹æ³•ç°‡ï¼Œåˆ†åˆ«æ˜¯ tp_as_numberã€tp_as_sequenceã€tp_as_mappingã€tp_as_asyncã€‚è¿™ä¸ª tp_as_async æˆ‘ä»¬æ²¡æœ‰è¯´ï¼Œå®ƒæ˜¯å’Œåç¨‹æœ‰å…³çš„ï¼Œæš‚æ—¶ä¸éœ€è¦ç®¡ã€‚æ€»ä¹‹å¦‚æœæƒ³æ”¹å˜æ“ä½œç¬¦çš„è¡¨ç°ç»“æœï¼Œé‚£ä¹ˆå°±é‡å†™é‡Œé¢å¯¹åº”çš„å‡½æ•°å³å¯ã€‚

~~~Python
from ctypes import *
import gc


# å°†è¿™äº›å¯¹è±¡æå‰å£°æ˜å¥½ï¼Œä¹‹åå†è¿›è¡Œæˆå‘˜çš„åˆå§‹åŒ–
class PyObject(Structure): pass


class PyTypeObject(Structure): pass


class PyNumberMethods(Structure): pass


class PySequenceMethods(Structure): pass


class PyMappingMethods(Structure): pass


class PyAsyncMethods(Structure): pass


class PyFile(Structure): pass


PyObject._fields_ = [("ob_refcnt", c_ssize_t),
                     ("ob_type", POINTER(PyTypeObject))]

PyTypeObject._fields_ = [
    ('ob_base', PyObject),
    ('ob_size', c_ssize_t),
    ('tp_name', c_char_p),
    ('tp_basicsize', c_ssize_t),
    ('tp_itemsize', c_ssize_t),
    ('tp_dealloc', CFUNCTYPE(None, py_object)),
    ('printfunc', CFUNCTYPE(c_int, py_object, POINTER(PyFile), c_int)),
    ('getattrfunc', CFUNCTYPE(py_object, py_object, c_char_p)),
    ('setattrfunc', CFUNCTYPE(c_int, py_object, c_char_p, py_object)),
    ('tp_as_async', CFUNCTYPE(PyAsyncMethods)),
    ('tp_repr', CFUNCTYPE(py_object, py_object)),
    ('tp_as_number', POINTER(PyNumberMethods)),
    ('tp_as_sequence', POINTER(PySequenceMethods)),
    ('tp_as_mapping', POINTER(PyMappingMethods)),
    ('tp_hash', CFUNCTYPE(c_int64, py_object)),
    ('tp_call', CFUNCTYPE(py_object, py_object, py_object, py_object)),
    ('tp_str', CFUNCTYPE(py_object, py_object)),
    # ä¸éœ€è¦çš„å¯ä»¥ä¸ç”¨å†™
]

# æ–¹æ³•é›†å°±æ˜¯ä¸€ä¸ªç»“æ„ä½“å®ä¾‹ï¼Œç»“æ„ä½“æˆå‘˜éƒ½æ˜¯å‡½æ•°æŒ‡é’ˆ
# æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¦å°†ç›¸å…³çš„å‡½æ•°ç±»å‹å£°æ˜å¥½
inquiry = CFUNCTYPE(c_int, py_object)
unaryfunc = CFUNCTYPE(py_object, py_object)
binaryfunc = CFUNCTYPE(py_object, py_object, py_object)
ternaryfunc = CFUNCTYPE(py_object, py_object, py_object, py_object)
lenfunc = CFUNCTYPE(c_ssize_t, py_object)
ssizeargfunc = CFUNCTYPE(py_object, py_object, c_ssize_t)
ssizeobjargproc = CFUNCTYPE(c_int, py_object, c_ssize_t, py_object)
objobjproc = CFUNCTYPE(c_int, py_object, py_object)
objobjargproc = CFUNCTYPE(c_int, py_object, py_object, py_object)

PyNumberMethods._fields_ = [
    ('nb_add', binaryfunc),
    ('nb_subtract', binaryfunc),
    ('nb_multiply', binaryfunc),
    ('nb_remainder', binaryfunc),
    ('nb_divmod', binaryfunc),
    ('nb_power', ternaryfunc),
    ('nb_negative', unaryfunc),
    ('nb_positive', unaryfunc),
    ('nb_absolute', unaryfunc),
    ('nb_bool', inquiry),
    ('nb_invert', unaryfunc),
    ('nb_lshift', binaryfunc),
    ('nb_rshift', binaryfunc),
    ('nb_and', binaryfunc),
    ('nb_xor', binaryfunc),
    ('nb_or', binaryfunc),
    ('nb_int', unaryfunc),
    ('nb_reserved', c_void_p),
    ('nb_float', unaryfunc),
    ('nb_inplace_add', binaryfunc),
    ('nb_inplace_subtract', binaryfunc),
    ('nb_inplace_multiply', binaryfunc),
    ('nb_inplace_remainder', binaryfunc),
    ('nb_inplace_power', ternaryfunc),
    ('nb_inplace_lshift', binaryfunc),
    ('nb_inplace_rshift', binaryfunc),
    ('nb_inplace_and', binaryfunc),
    ('nb_inplace_xor', binaryfunc),
    ('nb_inplace_or', binaryfunc),
    ('nb_floor_divide', binaryfunc),
    ('nb_true_divide', binaryfunc),
    ('nb_inplace_floor_divide', binaryfunc),
    ('nb_inplace_true_divide', binaryfunc),
    ('nb_index', unaryfunc),
    ('nb_matrix_multiply', binaryfunc),
    ('nb_inplace_matrix_multiply', binaryfunc)]

PySequenceMethods._fields_ = [
    ('sq_length', lenfunc),
    ('sq_concat', binaryfunc),
    ('sq_repeat', ssizeargfunc),
    ('sq_item', ssizeargfunc),
    ('was_sq_slice', c_void_p),
    ('sq_ass_item', ssizeobjargproc),
    ('was_sq_ass_slice', c_void_p),
    ('sq_contains', objobjproc),
    ('sq_inplace_concat', binaryfunc),
    ('sq_inplace_repeat', ssizeargfunc)]

# å°†è¿™äº›é­”æ³•æ–¹æ³•çš„åå­—å’Œåº•å±‚çš„ç»“æ„ä½“æˆå‘˜ç»„åˆèµ·æ¥
magic_method_dict = {
    "__add__": ("tp_as_number", "nb_add"),
    "__sub__": ("tp_as_number", "nb_subtract"),
    "__mul__": ("tp_as_number", "nb_multiply"),
    "__mod__": ("tp_as_number", "nb_remainder"),
    "__pow__": ("tp_as_number", "nb_power"),
    "__neg__": ("tp_as_number", "nb_negative"),
    "__pos__": ("tp_as_number", "nb_positive"),
    "__abs__": ("tp_as_number", "nb_absolute"),
    "__bool__": ("tp_as_number", "nb_bool"),
    "__inv__": ("tp_as_number", "nb_invert"),
    "__invert__": ("tp_as_number", "nb_invert"),
    "__lshift__": ("tp_as_number", "nb_lshift"),
    "__rshift__": ("tp_as_number", "nb_rshift"),
    "__and__": ("tp_as_number", "nb_and"),
    "__xor__": ("tp_as_number", "nb_xor"),
    "__or__": ("tp_as_number", "nb_or"),
    "__int__": ("tp_as_number", "nb_int"),
    "__float__": ("tp_as_number", "nb_float"),
    "__iadd__": ("tp_as_number", "nb_inplace_add"),
    "__isub__": ("tp_as_number", "nb_inplace_subtract"),
    "__imul__": ("tp_as_number", "nb_inplace_multiply"),
    "__imod__": ("tp_as_number", "nb_inplace_remainder"),
    "__ipow__": ("tp_as_number", "nb_inplace_power"),
    "__ilshift__": ("tp_as_number", "nb_inplace_lshift"),
    "__irshift__": ("tp_as_number", "nb_inplace_rshift"),
    "__iand__": ("tp_as_number", "nb_inplace_and"),
    "__ixor__": ("tp_as_number", "nb_inplace_xor"),
    "__ior__": ("tp_as_number", "nb_inplace_or"),
    "__floordiv__": ("tp_as_number", "nb_floor_divide"),
    "__div__": ("tp_as_number", "nb_true_divide"),
    "__ifloordiv__": ("tp_as_number", "nb_inplace_floor_divide"),
    "__idiv__": ("tp_as_number", "nb_inplace_true_divide"),
    "__index__": ("tp_as_number", "nb_index"),
    "__matmul__": ("tp_as_number", "nb_matrix_multiply"),
    "__imatmul__": ("tp_as_number", "nb_inplace_matrix_multiply"),

    "__len__": ("tp_as_sequence", "sq_length"),
    "__concat__": ("tp_as_sequence", "sq_concat"),
    "__repeat__": ("tp_as_sequence", "sq_repeat"),
    "__getitem__": ("tp_as_sequence", "sq_item"),
    "__setitem__": ("tp_as_sequence", "sq_ass_item"),
    "__contains__": ("tp_as_sequence", "sq_contains"),
    "__iconcat__": ("tp_as_sequence", "sq_inplace_concat"),
    "__irepeat__": ("tp_as_sequence", "sq_inplace_repeat")
}
keep_method_alive = {}
keep_method_set_alive = {}


# ä»¥ä¸Šå°±å‡†å¤‡å°±ç»ªäº†
# ä¸‹é¢å†å°†ä¹‹å‰çš„ patch_builtin_class å‡½æ•°è¡¥å……ä¸€ä¸‹å³å¯
def patch_builtin_class(cls, name, value):
    """
    :param cls: è¦ä¿®æ”¹çš„ç±»
    :param name: å±æ€§åæˆ–è€…å‡½æ•°å
    :param value: å€¼
    :return:
    """
    if type(cls) is not type:
        raise ValueError("cls å¿…é¡»æ˜¯ä¸€ä¸ªç±»å¯¹è±¡")
    cls_attrs = gc.get_referents(cls.__dict__)[0]
    old_value = cls_attrs.get(name, None)
    cls_attrs[name] = value
    if old_value is not None:
        try:
            value.__name__ = old_value.__name__
            value.__qualname__ = old_value.__qualname__
        except AttributeError:
            pass
        cls_attrs[f"_{cls.__name__}_{name}"] = old_value
    pythonapi.PyType_Modified(py_object(cls))
    # ä»¥ä¸Šé€»è¾‘ä¸å˜ï¼Œç„¶åå¯¹å‚æ•° name è¿›è¡Œæ£€æµ‹
    # å¦‚æœæ˜¯é­”æ–¹æ–¹æ³•ã€å¹¶ä¸” value æ˜¯ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œé‚£ä¹ˆä¿®æ”¹æ“ä½œç¬¦
    # å¦åˆ™ç›´æ¥ return
    if not (name in magic_method_dict and callable(value)):
        return
    # æ¯”å¦‚ name æ˜¯ __sub__
    # é‚£ä¹ˆ tp_as_name, rewrite == "tp_as_number", "nb_sub"
    tp_as_name, rewrite = magic_method_dict[name]
    # è·å–ç±»å¯¹åº”çš„åº•å±‚ç»“æ„ï¼ŒPyTypeObject å®ä¾‹
    type_obj = PyTypeObject.from_address(id(cls))
    # æ ¹æ® tp_as_name åˆ¤æ–­åˆ°åº•æ˜¯å“ªä¸€ä¸ªæ–¹æ³•é›†
    # è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰å®ç° tp_as_mapping å’Œ tp_as_async
    # æœ‰å…´è¶£å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸‹
    struct_method_set_class = (
        PyNumberMethods if tp_as_name == "tp_as_number"
        else PySequenceMethods if tp_as_name == "tp_as_sequence"
        else PyMappingMethods if tp_as_name == "tp_as_mapping"
        else PyAsyncMethods)
    
    # è·å–å…·ä½“çš„æ–¹æ³•é›†ï¼ˆæŒ‡é’ˆï¼‰
    struct_method_set_ptr = getattr(type_obj, tp_as_name, None)
    if not struct_method_set_ptr:
        # å¦‚æœä¸å­˜åœ¨æ­¤æ–¹æ³•é›†ï¼Œæˆ‘ä»¬å®ä¾‹åŒ–ä¸€ä¸ªï¼Œç„¶åè®¾ç½®åˆ°é‡Œé¢å»
        struct_method_set = struct_method_set_class()
        # æ³¨æ„æˆ‘ä»¬è¦ä¼ ä¸€ä¸ªæŒ‡é’ˆè¿›å»
        setattr(type_obj, tp_as_name, pointer(struct_method_set))
    # ç„¶åå¯¹æŒ‡é’ˆè¿›è¡Œè§£å¼•ç”¨ï¼Œè·å–æ–¹æ³•é›†ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”çš„ç»“æ„ä½“å®ä¾‹
    struct_method_set = struct_method_set_ptr.contents
    # éå† struct_method_set_classï¼Œåˆ¤æ–­åˆ°åº•é‡å†™çš„æ˜¯å“ªä¸€ä¸ªé­”æ³•æ–¹æ³•
    cfunc_type = None
    for field, ftype in struct_method_set_class._fields_:
        if field == rewrite:
            cfunc_type = ftype
    # æ„é€ æ–°çš„å‡½æ•°
    cfunc = cfunc_type(value)
    # æ›´æ–°æ–¹æ³•é›†
    setattr(struct_method_set, rewrite, cfunc)
    # è‡³æ­¤æˆ‘ä»¬çš„åŠŸèƒ½å°±å®Œæˆäº†ï¼Œä½†è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹ï¼Œå°±æ˜¯ä¸Šé¢çš„ cfunc
    # è™½ç„¶å®ƒæ˜¯ä¸€ä¸ªåº•å±‚å¯ä»¥è¯†åˆ«çš„ C å‡½æ•°ï¼Œä½†å®ƒæœ¬è´¨ä¸Šä»ç„¶æ˜¯ä¸€ä¸ª Python å¯¹è±¡
    # å…¶å†…éƒ¨ç»´æŠ¤äº† C çº§æ•°æ®ï¼Œèµ‹å€¼ä¹‹ååº•å±‚ä¼šè‡ªåŠ¨æå–ï¼Œè€Œè¿™ä¸€æ­¥ä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°
    # æ‰€ä»¥è¿™ä¸ªå‡½æ•°ç»“æŸä¹‹åï¼Œcfunc å°±è¢«é”€æ¯äº†ï¼ˆè¿åŒå†…éƒ¨çš„ C çº§æ•°æ®ï¼‰
    # è¿™æ ·åç»­å†è°ƒç”¨ç›¸å…³æ“ä½œç¬¦çš„æ—¶å€™å°±ä¼šå‡ºç°æ®µé”™è¯¯ï¼Œè§£é‡Šå™¨å¼‚å¸¸é€€å‡º
    # å› æ­¤æˆ‘ä»¬éœ€è¦åœ¨å‡½æ•°ç»“æŸä¹‹å‰åˆ›å»ºä¸€ä¸ªåœ¨å¤–éƒ¨æŒæœ‰å®ƒçš„å¼•ç”¨
    keep_method_alive[(cls, name)] = cfunc
    # å½“ç„¶è¿˜æœ‰æˆ‘ä»¬ä¸Šé¢çš„æ–¹æ³•é›†ï¼Œä¹Ÿæ˜¯åŒç†
    keep_method_set_alive[(cls, name)] = struct_method_set
~~~

ä»£ç é‡è¿˜æ˜¯ç¨å¾®æœ‰ç‚¹å¤šçš„ï¼Œä½†æ˜¯ä¸éš¾ç†è§£ï¼Œæˆ‘ä»¬å°†è¿™äº›ä»£ç æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶é‡Œé¢ï¼Œæ–‡ä»¶åå°±å« unsafe_magic.pyï¼Œç„¶åå¯¼å…¥å®ƒã€‚

```Python
from unsafe_magic import patch_builtin_class


# é‡è½½ [] æ“ä½œç¬¦
patch_builtin_class(int, 
                    "__getitem__", 
                    lambda self, item: "_".join([str(self)] * item))
# é‡è½½ @ æ“ä½œç¬¦
patch_builtin_class(str, 
                    "__matmul__", 
                    lambda self, other: (self, other))
# é‡è½½ - æ“ä½œç¬¦
patch_builtin_class(str, 
                    "__sub__",
                    lambda self, other: other + self)

# æ·»åŠ ä¸€ä¸ªæ–¹æ³•
patch_builtin_class(str,
                    "ç¬‘ä¸€ä¸ª",
                    lambda self: "ğŸ˜Šç¬‘ä¸€ä¸ªğŸ˜Š")
```

ä½ è§‰å¾—ä¹‹åä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼š

![](./images/396.png)

æ€ä¹ˆæ ·ï¼Œæ˜¯ä¸æ˜¯å¾ˆå¥½ç©å‘¢ï¼Ÿ

~~~python
from unsafe_magic import patch_builtin_class


patch_builtin_class(tuple, "append", lambda self, item: self + (item, ))
t = ()
print(t.append(1).append(2).append(3).append(4))  # (1, 2, 3, 4)
~~~

å› æ­¤ Python ç»™å¼€å‘è€…èµ‹äºˆçš„æƒé™æ˜¯éå¸¸é«˜çš„ï¼Œä½ å¯ä»¥ç©å‡ºå¾ˆå¤šæ„æƒ³ä¸åˆ°çš„æ–°èŠ±æ ·ã€‚

å¦å¤–å†å¤šè¯´ä¸€å¥ï¼Œå½“å¯¹è±¡ä¸æ”¯æŒæŸä¸ªæ“ä½œç¬¦çš„æ—¶å€™ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè®©å®ƒå®ç°è¯¥æ“ä½œç¬¦ï¼›ä½†å¦‚æœå¯¹è±¡å·²ç»å®ç°äº†æŸä¸ªæ“ä½œç¬¦ï¼Œé‚£ä¹ˆå…¶é€»è¾‘å°±æ”¹ä¸äº†äº†ï¼Œä¸¾ä¸ªæ —å­ï¼š

~~~python
from unsafe_magic import patch_builtin_class

# str æ²¡æœ‰ __div__ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºå…¶å®ç°ï¼Œæ­¤æ—¶å­—ç¬¦ä¸²ä¾¿æ‹¥æœ‰äº†é™¤æ³•çš„åŠŸèƒ½
patch_builtin_class(str, 
                    "__div__", 
                    lambda self, other: (self, other))
print("hello" / "world")  # ('hello', 'world')

# ä½† __add__ æ˜¯ str æœ¬èº«å°±æœ‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å­—ç¬¦ä¸²æœ¬èº«å°±å¯ä»¥ç›¸åŠ 
# é‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬å°±æ— æ³•è¦†ç›–åŠ æ³•è¿™ä¸ªæ“ä½œç¬¦äº†
patch_builtin_class(str, 
                    "__add__", 
                    lambda self, other: (self, other))
print("ä½ " + "å¥½")  # ä½ å¥½

# ä¸Šé¢ä½¿ç”¨åŠ å·ï¼Œå¹¶æ²¡æœ‰èµ°æˆ‘ä»¬é‡å†™ä¹‹åçš„ __add__ æ–¹æ³•ï¼Œå› ä¸ºå­—ç¬¦ä¸²æœ¬èº«å°±æ”¯æŒåŠ æ³•è¿ç®—
# ä½†ä¹Ÿæœ‰ä¾‹å¤–ï¼Œå°±æ˜¯å½“å‡ºç° TypeError çš„æ—¶å€™ï¼Œé‚£ä¹ˆè§£é‡Šå™¨ä¼šæ‰§è¡Œæˆ‘ä»¬é‡å†™çš„æ–¹æ³•
# æ¯”å¦‚å­—ç¬¦ä¸²å’Œæ•´æ•°ç›¸åŠ ä¼šå‡ºç° TypeErrorï¼Œå› æ­¤è§£é‡Šå™¨ä¼šæ‰§è¡Œé‡å†™çš„ __add__
print("ä½ " + 123)  # ('ä½ ', 123)
# ä½†å¦‚æœæ˜¯è°ƒç”¨é­”æ–¹æ–¹æ³•ï¼Œé‚£ä¹ˆä¼šç›´æ¥èµ°é‡å†™çš„ __add__
print("ä½ ".__add__("å¥½"))  # ('ä½ ', 'å¥½')
~~~

ä¸è¿‡ä¸Šè¿°è¿™ä¸ªé—®é¢˜åœ¨ 3.6 ç‰ˆæœ¬çš„æ—¶å€™æ˜¯æ²¡æœ‰çš„ï¼Œæ“ä½œç¬¦ä¼šæ— æ¡ä»¶åœ°æ‰§è¡Œæˆ‘ä»¬é‡å†™çš„é­”æ³•æ–¹æ³•ã€‚ä½†åœ¨ 3.8 çš„æ—¶å€™å‡ºç°äº†è¿™ä¸ªç°è±¡ï¼Œè‡³äºæ›´é«˜ç‰ˆæœ¬çš„ Pythonï¼Œå¯ä»¥è‡ªå·±æµ‹è¯•ä¸€ä¸‹ã€‚

## å°ç»“

ä»¥ä¸Šæˆ‘ä»¬å°±ç”¨ ctypes ç©äº†ä¸€äº›éªšæ“ä½œï¼Œå†…å®¹è¿˜æ˜¯æœ‰ç‚¹å•è°ƒï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ç©çš„å†å—¨ä¸€äº›ã€‚ä½†æ˜¯æ— è®ºå¦‚ä½•ï¼Œä¸€å®šä¸è¦åœ¨ç”Ÿäº§ä¸Šä½¿ç”¨ï¼Œçº¿ä¸Šä¸è¦å‡ºç°è¿™ç§ä¼šæ”¹å˜è§£é‡Šå™¨è¿è¡Œé€»è¾‘çš„ä»£ç ã€‚å¦‚æœåªæ˜¯ä¸ºäº†è°ƒè¯•ã€æˆ–è€…æƒ³ä»å®è·µçš„å±‚é¢æ›´æ·±å…¥åœ°äº†è§£è™šæ‹Ÿæœºï¼Œé‚£ä¹ˆæ²¡äº‹å¯ä»¥ç©ä¸€ç©ã€‚

------

&nbsp;

**æ¬¢è¿å¤§å®¶å…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼šå¤æ˜åœ°è§‰çš„ç¼–ç¨‹æ•™å®¤ã€‚**

![](./images/qrcode_for_gh.jpg)

**å¦‚æœè§‰å¾—æ–‡ç« å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œä¹Ÿå¯ä»¥è¯·ä½œè€…åƒä¸ªé¦’å¤´ï¼ŒThanksâ™ª(ï½¥Ï‰ï½¥)ï¾‰ã€‚**

![](./images/supports.png)